{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Vigil Guard Audit Report",
  "description": "Schema for code audit reports generated by code-audit-expert",
  "type": "object",
  "required": ["metadata", "summary", "categories", "leverage_points"],
  "properties": {
    "metadata": {
      "type": "object",
      "description": "Audit execution metadata",
      "required": ["audit_id", "timestamp", "project", "scope"],
      "properties": {
        "audit_id": {
          "type": "string",
          "description": "Unique audit identifier",
          "pattern": "^(vigil-)?audit-\\d{8}-[a-z0-9]+$",
          "examples": ["vigil-audit-20251208-abc123"]
        },
        "timestamp": {
          "type": "string",
          "format": "date-time",
          "description": "ISO 8601 timestamp of audit execution"
        },
        "project": {
          "type": "string",
          "description": "Project name",
          "examples": ["vigil-guard", "vigil-code"]
        },
        "version": {
          "type": "string",
          "description": "Project version audited",
          "pattern": "^\\d+\\.\\d+\\.\\d+$",
          "examples": ["1.7.9", "1.6.11"]
        },
        "scope": {
          "type": "string",
          "enum": ["full", "quick", "category"],
          "description": "Audit scope type"
        },
        "duration_seconds": {
          "type": "number",
          "minimum": 0,
          "description": "Total audit duration in seconds"
        },
        "auditor": {
          "type": "string",
          "description": "Agent that performed the audit",
          "default": "code-audit-expert"
        }
      }
    },
    "summary": {
      "type": "object",
      "description": "Aggregate audit results",
      "required": ["total_score", "max_score", "grade"],
      "properties": {
        "total_score": {
          "type": "number",
          "minimum": 0,
          "maximum": 100,
          "description": "Total points earned"
        },
        "max_score": {
          "type": "number",
          "minimum": 0,
          "maximum": 100,
          "description": "Maximum possible points for scope"
        },
        "percentage": {
          "type": "number",
          "minimum": 0,
          "maximum": 100,
          "description": "Score as percentage"
        },
        "grade": {
          "type": "string",
          "enum": ["A", "B", "C", "D", "F"],
          "description": "Letter grade based on percentage"
        },
        "production_ready": {
          "type": "boolean",
          "description": "Whether project meets production thresholds"
        },
        "critical_issues": {
          "type": "number",
          "minimum": 0,
          "description": "Count of CRITICAL findings"
        },
        "warnings": {
          "type": "number",
          "minimum": 0,
          "description": "Count of NEEDS_IMPROVEMENT findings"
        },
        "executive_summary": {
          "type": "string",
          "description": "2-3 sentence overview of audit results",
          "maxLength": 500
        }
      }
    },
    "categories": {
      "type": "object",
      "description": "Results per audit category",
      "additionalProperties": {
        "type": "object",
        "required": ["name", "max_points", "earned_points", "rating"],
        "properties": {
          "name": {
            "type": "string",
            "description": "Human-readable category name"
          },
          "max_points": {
            "type": "number",
            "minimum": 0,
            "description": "Maximum points for this category"
          },
          "earned_points": {
            "type": "number",
            "minimum": 0,
            "description": "Points earned in this category"
          },
          "percentage": {
            "type": "number",
            "minimum": 0,
            "maximum": 100
          },
          "rating": {
            "type": "string",
            "enum": ["OK", "NEEDS_IMPROVEMENT", "CRITICAL"],
            "description": "Category rating"
          },
          "checklist": {
            "type": "array",
            "description": "Checklist items with pass/fail status",
            "items": {
              "type": "object",
              "properties": {
                "item": { "type": "string" },
                "passed": { "type": "boolean" },
                "note": { "type": "string" }
              },
              "required": ["item", "passed"]
            }
          },
          "findings": {
            "type": "array",
            "description": "Detailed findings for this category",
            "items": {
              "type": "object",
              "required": ["type", "description"],
              "properties": {
                "type": {
                  "type": "string",
                  "enum": ["positive", "warning", "critical"],
                  "description": "Finding severity"
                },
                "description": {
                  "type": "string",
                  "description": "Finding description"
                },
                "location": {
                  "type": "string",
                  "description": "File path or location",
                  "examples": ["services/web-ui/backend/src/server.ts:123"]
                },
                "recommendation": {
                  "type": "string",
                  "description": "Suggested fix or improvement"
                }
              }
            }
          }
        }
      }
    },
    "leverage_points": {
      "type": "array",
      "description": "Top 5-10 high-impact improvement opportunities",
      "maxItems": 10,
      "items": {
        "type": "object",
        "required": ["rank", "title", "category", "impact", "effort"],
        "properties": {
          "rank": {
            "type": "number",
            "minimum": 1,
            "maximum": 10,
            "description": "Priority ranking (1 = highest)"
          },
          "title": {
            "type": "string",
            "description": "Short improvement title",
            "maxLength": 100
          },
          "category": {
            "type": "string",
            "description": "Audit category this relates to"
          },
          "impact": {
            "type": "string",
            "enum": ["HIGH", "MEDIUM", "LOW"],
            "description": "Expected improvement impact"
          },
          "effort": {
            "type": "string",
            "enum": ["HIGH", "MEDIUM", "LOW"],
            "description": "Implementation effort required"
          },
          "leverage_score": {
            "type": "number",
            "description": "Impact / Effort ratio (higher = better ROI)"
          },
          "rationale": {
            "type": "string",
            "description": "Why this improvement matters"
          },
          "recommendation": {
            "type": "string",
            "description": "Specific action to take"
          }
        }
      }
    },
    "vigil_specific": {
      "type": "object",
      "description": "Vigil Guard project-specific metrics",
      "properties": {
        "workflow_nodes": {
          "type": "number",
          "description": "Number of nodes in n8n workflow"
        },
        "detection_categories": {
          "type": "number",
          "description": "Number of detection pattern categories"
        },
        "test_count": {
          "type": "number",
          "description": "Total test count"
        },
        "test_pass_rate": {
          "type": "number",
          "minimum": 0,
          "maximum": 100,
          "description": "Test pass percentage"
        },
        "owasp_aitg": {
          "type": "object",
          "description": "OWASP AITG compliance scores",
          "properties": {
            "app01": {
              "type": "number",
              "minimum": 0,
              "maximum": 100,
              "description": "APP-01 Direct injection detection %"
            },
            "app02": {
              "type": "number",
              "minimum": 0,
              "maximum": 100,
              "description": "APP-02 Indirect injection detection %"
            },
            "app07": {
              "type": "number",
              "minimum": 0,
              "maximum": 100,
              "description": "APP-07 Prompt extraction detection %"
            }
          }
        },
        "presidio_languages": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Supported PII detection languages"
        },
        "redos_safe": {
          "type": "boolean",
          "description": "All regex patterns ReDoS-safe"
        }
      }
    },
    "ooda": {
      "type": "object",
      "description": "OODA protocol execution record",
      "properties": {
        "observe": {
          "type": "string",
          "description": "What was observed about the codebase"
        },
        "orient": {
          "type": "string",
          "description": "Options considered and assessment"
        },
        "decide": {
          "type": "string",
          "description": "Decision made and reasoning"
        },
        "act": {
          "type": "string",
          "description": "Actions taken during audit"
        }
      }
    }
  },
  "examples": [
    {
      "metadata": {
        "audit_id": "vigil-audit-20251208-abc123",
        "timestamp": "2025-12-08T10:30:00Z",
        "project": "vigil-guard",
        "version": "1.7.9",
        "scope": "full",
        "duration_seconds": 45
      },
      "summary": {
        "total_score": 62,
        "max_score": 75,
        "percentage": 82.7,
        "grade": "B",
        "production_ready": true,
        "critical_issues": 0,
        "warnings": 3,
        "executive_summary": "Vigil Guard demonstrates solid architecture with comprehensive test coverage. Key areas for improvement: reduce technical debt (23 TODOs) and split large files."
      },
      "categories": {
        "structure": {
          "name": "Structure & Architecture",
          "max_points": 10,
          "earned_points": 8,
          "percentage": 80,
          "rating": "OK",
          "findings": [
            {
              "type": "positive",
              "description": "Clear microservices architecture with 9 services"
            },
            {
              "type": "warning",
              "description": "server.ts exceeds 800 lines",
              "location": "services/web-ui/backend/src/server.ts",
              "recommendation": "Extract route handlers to separate files"
            }
          ]
        }
      },
      "leverage_points": [
        {
          "rank": 1,
          "title": "Reduce TODO comments in workflow service",
          "category": "techdebt",
          "impact": "HIGH",
          "effort": "MEDIUM",
          "leverage_score": 2.0,
          "rationale": "23 TODOs indicate unfinished work blocking progress",
          "recommendation": "Triage TODOs: resolve, convert to issues, or remove"
        }
      ],
      "vigil_specific": {
        "workflow_nodes": 40,
        "detection_categories": 44,
        "test_count": 165,
        "test_pass_rate": 100,
        "owasp_aitg": {
          "app01": 96,
          "app02": 82.5
        },
        "presidio_languages": ["pl", "en"],
        "redos_safe": true
      }
    }
  ]
}
