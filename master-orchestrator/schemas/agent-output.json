{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Agent Output Message",
  "description": "Standardized output message format from all agents",
  "type": "object",
  "required": [
    "version",
    "message_id",
    "timestamp",
    "agent",
    "status",
    "output",
    "metadata"
  ],
  "properties": {
    "version": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+\\.\\d+$",
      "description": "Protocol version (semver)"
    },
    "message_id": {
      "type": "string",
      "format": "uuid",
      "description": "Unique message identifier"
    },
    "timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "Message creation timestamp (ISO-8601)"
    },
    "agent": {
      "type": "string",
      "enum": [
        "workflow-business-logic-agent",
        "workflow-infrastructure-agent",
        "test-automation-agent",
        "backend-api-agent",
        "frontend-ui-agent",
        "data-analytics-agent",
        "pii-detection-agent",
        "infrastructure-deployment-agent",
        "security-compliance-agent",
        "documentation-agent"
      ],
      "description": "Responding agent identifier"
    },
    "status": {
      "type": "string",
      "enum": ["SUCCESS", "FAILURE", "WARNING", "PARTIAL", "SKIPPED"],
      "description": "Operation result status"
    },
    "output": {
      "type": "object",
      "required": ["summary"],
      "properties": {
        "summary": {
          "type": "string",
          "description": "Brief summary of what was accomplished"
        },
        "details": {
          "type": "object",
          "description": "Agent-specific detailed output",
          "additionalProperties": true
        },
        "artifacts": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["type", "path", "action"],
            "properties": {
              "type": {
                "type": "string",
                "enum": ["file", "command", "config", "test", "documentation"]
              },
              "path": {
                "type": "string",
                "description": "Path to artifact"
              },
              "action": {
                "type": "string",
                "enum": ["created", "modified", "deleted", "executed"]
              },
              "description": {
                "type": "string"
              },
              "content_preview": {
                "type": "string",
                "maxLength": 500,
                "description": "Preview of artifact content"
              }
            }
          }
        },
        "results": {
          "type": "object",
          "description": "Quantifiable results",
          "properties": {
            "tests_passed": {
              "type": "integer"
            },
            "tests_failed": {
              "type": "integer"
            },
            "patterns_added": {
              "type": "integer"
            },
            "vulnerabilities_found": {
              "type": "integer"
            },
            "files_changed": {
              "type": "integer"
            }
          }
        }
      }
    },
    "next_steps": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["action"],
        "properties": {
          "action": {
            "type": "string",
            "description": "Required or recommended action"
          },
          "urgency": {
            "type": "string",
            "enum": ["immediate", "soon", "eventual", "optional"],
            "default": "soon"
          },
          "type": {
            "type": "string",
            "enum": ["manual", "automated", "verification", "decision"]
          },
          "command": {
            "type": "string",
            "description": "Command to execute (if applicable)"
          },
          "description": {
            "type": "string",
            "description": "Additional context for the action"
          }
        }
      }
    },
    "state_updates": {
      "type": "object",
      "description": "Updates to shared workflow state",
      "additionalProperties": true
    },
    "files_modified": {
      "type": "array",
      "items": {
        "type": "string"
      },
      "description": "List of files modified during execution"
    },
    "services_affected": {
      "type": "array",
      "items": {
        "type": "string",
        "enum": [
          "n8n",
          "presidio-pii-api",
          "language-detector",
          "prompt-guard-api",
          "clickhouse",
          "grafana",
          "web-ui-backend",
          "web-ui-frontend",
          "proxy"
        ]
      },
      "description": "Services impacted by the operation"
    },
    "warnings": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["level", "message"],
        "properties": {
          "level": {
            "type": "string",
            "enum": ["info", "warning", "error"]
          },
          "code": {
            "type": "string",
            "description": "Warning code for programmatic handling"
          },
          "message": {
            "type": "string",
            "description": "Human-readable warning message"
          },
          "suggestion": {
            "type": "string",
            "description": "How to address this warning"
          },
          "documentation_link": {
            "type": "string",
            "format": "uri",
            "description": "Link to relevant documentation"
          }
        }
      }
    },
    "errors": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["code", "message"],
        "properties": {
          "code": {
            "type": "string",
            "description": "Standardized error code"
          },
          "message": {
            "type": "string",
            "description": "Error description"
          },
          "recoverable": {
            "type": "boolean",
            "default": false,
            "description": "Whether the error is recoverable"
          },
          "retry_suggestion": {
            "type": "string",
            "description": "Suggestion for retry attempt"
          },
          "stack_trace": {
            "type": "string",
            "description": "Stack trace (debug mode only)"
          },
          "context": {
            "type": "object",
            "description": "Additional error context",
            "additionalProperties": true
          }
        }
      }
    },
    "metrics": {
      "type": "object",
      "properties": {
        "execution_time_ms": {
          "type": "integer",
          "minimum": 0,
          "description": "Total execution time in milliseconds"
        },
        "operations_count": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of operations performed"
        },
        "confidence_score": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Confidence in the result (0-1)"
        },
        "resource_usage": {
          "type": "object",
          "properties": {
            "cpu_percent": {
              "type": "number"
            },
            "memory_mb": {
              "type": "number"
            },
            "network_requests": {
              "type": "integer"
            }
          }
        },
        "cache_hits": {
          "type": "integer",
          "description": "Number of cache hits during execution"
        },
        "cache_misses": {
          "type": "integer",
          "description": "Number of cache misses during execution"
        }
      }
    },
    "metadata": {
      "type": "object",
      "required": [
        "agent_version",
        "correlation_id"
      ],
      "properties": {
        "agent_version": {
          "type": "string",
          "pattern": "^\\d+\\.\\d+\\.\\d+$",
          "description": "Agent version"
        },
        "correlation_id": {
          "type": "string",
          "format": "uuid",
          "description": "Workflow correlation identifier"
        },
        "parent_message_id": {
          "type": "string",
          "format": "uuid",
          "description": "Input message that triggered this response"
        },
        "requires_followup": {
          "type": "boolean",
          "default": false,
          "description": "Whether follow-up action is required"
        },
        "can_retry": {
          "type": "boolean",
          "default": true,
          "description": "Whether operation can be retried on failure"
        },
        "idempotent": {
          "type": "boolean",
          "default": false,
          "description": "Whether operation is idempotent"
        },
        "environment": {
          "type": "string",
          "enum": ["development", "staging", "production"],
          "description": "Execution environment"
        },
        "debug_info": {
          "type": "object",
          "description": "Additional debug information",
          "additionalProperties": true
        }
      }
    }
  }
}